#!/usr/bin/env python

"""
s_components': [{u'long_name': u'New Delhi',
   u'short_name': u'New Delhi',
   u'types': [u'locality', u'political']},
  {u'long_name': u'Delhi',
   u'short_name': u'DL',
   u'types': [u'administrative_area_level_1', u'political']},
  {u'long_name': u'India',
   u'short_name': u'IN',
   u'types': [u'country', u'political']},
  {u'long_name': u'110016',
   u'short_name': u'110016',
   u'types': [u'postal_code']}],
 u'adr_address': u'9A &amp; 12, Hauz Khas Village, <span class="locality">New Delhi</span>, <span class="region">Delhi</span> <span class="postal-code">110016</span>, <span class="country-name">India</span>',
 u'formatted_address': u'9A & 12, Hauz Khas Village, New Delhi, Delhi 110016, India',
 u'formatted_phone_number': u'078386 52814',
 u'geometry': {u'location': {u'lat': Decimal('28.5545643'),
   u'lng': Decimal('77.19450139999999')}},
 u'icon': u'https://maps.gstatic.com/mapfiles/place_api/icons/restaurant-71.png',
 u'id': u'e4d7e0a6761b9cb7240e3d76b16cd672df4d0066',
 u'international_phone_number': u'+91 78386 52814',
 u'name': u'Hauz Khas Social',
 u'opening_hours': {u'open_now': True,
  u'periods': [{u'close': {u'day': 1, u'time': u'0100'},
    u'open': {u'day': 0, u'time': u'1100'}},
   {u'close': {u'day': 2, u'time': u'0100'},
    u'open': {u'day': 1, u'time': u'1100'}},
   {u'close': {u'day': 3, u'time': u'0100'},
    u'open': {u'day': 2, u'time': u'1100'}},
   {u'close': {u'day': 4, u'time': u'0100'},
    u'open': {u'day': 3, u'time': u'1100'}},
   {u'close': {u'day': 5, u'time': u'0100'},
    u'open': {u'day': 4, u'time': u'1100'}},
   {u'close': {u'day': 6, u'time': u'0100'},
    u'open': {u'day': 5, u'time': u'1100'}},
   {u'close': {u'day': 0, u'time': u'0100'},
    u'open': {u'day': 6, u'time': u'1100'}}],
  u'weekday_text': [u'Monday: 11:00 AM \u2013 1:00 AM',
   u'Tuesday: 11:00 AM \u2013 1:00 AM',
   u'Wednesday: 11:00 AM \u2013 1:00 AM',
   u'Thursday: 11:00 AM \u2013 1:00 AM',
   u'Friday: 11:00 AM \u2013 1:00 AM',
   u'Saturday: 11:00 AM \u2013 1:00 AM',
   u'Sunday: 11:00 AM \u2013 1:00 AM']},
 u'photos': [{u'height': 3562,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/104096622138932892371/photos">Hauz Khas Social</a>'],
   u'photo_reference': u'CmRdAAAAiy9GwJW11xCIOx9TduQm_82prfkk10Vzkf6HN9BOLdypq4xThAqBa992RE5kCCodyOOQxPynIuRxlrL7sQBRR_x63ROcsnShfPM1IKje90xJhnPnMOH_RaF43HgCRhoLEhAyiVOL5h6I6fd3IJbjxAraGhQ9Bsphgn1q7JcF34yQnxkgpw4mzA',
   u'width': 5343},
  {u'height': 3744,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/104096622138932892371/photos">Hauz Khas Social</a>'],
   u'photo_reference': u'CmRdAAAAl3GMqskvwz_2LZkg7kBQ524XNuZogUw4aJ2ix8Zr6j-o469WBIE-vtY2saQ_VggpXqDCTXeOZ8ATHv5Kt0-IwkKJqXlnJPCT979pnyvARuJ8c9BB5Nx96OPWx5oTD6HLEhBSwzon6zH1HS6LdSx191NcGhTkmrNS5ZX3ZMPRKQeZwkkyi-RTXg',
   u'width': 5616},
  {u'height': 2048,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/104096622138932892371/photos">Hauz Khas Social</a>'],
   u'photo_reference': u'CmRdAAAAAJWi7v0Xy3VIn-ZIEGuaM4L_guAual2r2tXeIyJPBX6RXIedw_aRuWZOWS_NYRbEiSyoD9W5GBsSLsyj0WLeN4KIbAOlIiA2zCoBPrHTnQJL9rLC2O_PgK6pztHkGSVQEhD10j5O8EF_-XhmwwPuYNNWGhR8OVUYubLXnzvlFduF9DG2B_SkAg',
   u'width': 1365},
  {u'height': 1801,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/104096622138932892371/photos">Hauz Khas Social</a>'],
   u'photo_reference': u'CmRdAAAArU_CfvJVT_9asxxl1SZBpp64Yp9Zj0xjUEe1xebrQ9lyKq2qhDzW8mYF0ORC5m40K8oS-Y7LaSjlgYibQ1nybod9l5rgpEYxKbSBvzekRQ7e0Dnw_6ZZw5L0JQB8zw44EhAyZYoea7_0MHNpKACVU599GhQHdcPSTSvaHkjpHtSeo-eEYG70mw',
   u'width': 2700},
  {u'height': 3264,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/108633480572335245439/photos">Anubhav K.</a>'],
   u'photo_reference': u'CmRdAAAA4tdkma0RCR1BJsA4ZTP1ppY9wbVZno6Hn0vKPnvAUwr_jNDjeKhY3dzhMCowSBuhw4JQnILx-Met6VOfteSdWmB2ztQbv0pizn7x5YeL5yXLtocKrVr2OE3Ltlq-cdLfEhAZnVfaOK9g2yaREilrZsXZGhTIqHj-n9lXOxS1AKr7w61WXkMVyg',
   u'width': 2448},
  {u'height': 3744,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/104096622138932892371/photos">Hauz Khas Social</a>'],
   u'photo_reference': u'CmRdAAAAdQ5nhRqCms7-nWWGsVcuJ4L-Yl3ThHNRzuUq0hKSA7F78p5S-wQddVbNz7fOWLfz2w3-GqxV1fdmkPAWdA8WRXXYN72BRE8vo1cY73fNj1jkjDOuJCVRIGvuNTAvx4F9EhAa8z-b9nkUjoWnzd9wo1omGhRKPAkuzs6v5Sk8MiPBxNa0rgiybg',
   u'width': 5616},
  {u'height': 1920,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/100829696974981817294/photos">TechnOptics _</a>'],
   u'photo_reference': u'CmRdAAAAEdAW7BwwZciEEC83rRReZFA4J1wuwnlaZAy0RGCH-4X8ua3VAuN1yBKphIGaRAxVwiAlyrdh3VFO3ah_JpIpOetm6o9e5X3t18Ys7Yp8RSkttCvoTVUhP7yfTapXtdt2EhAJs4WUtpeQpy1lC9JXNMN-GhRiqL5o2EiOlMqxkUAipKZ_Yqbw0Q',
   u'width': 2560},
  {u'height': 2560,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/100829696974981817294/photos">TechnOptics _</a>'],
   u'photo_reference': u'CmRdAAAAMZfL17Wb2vpqn2ZGEGYRc1NBTFQ2sYHAMbN4P90jHSmTTQxReR49cpb8AMHhR3vmMUiHJqs4vFsJsaW5TyN1HCQWZhonE2_D6YFTjty3kY8gZtOtmrzJ0Y9BVaVqEDswEhB7gsWMR27v1lJ_sA-USAT_GhS1NfLnkzfygB7LoRB8-PN_IYrKog',
   u'width': 1920},
  {u'height': 2048,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/104096622138932892371/photos">Hauz Khas Social</a>'],
   u'photo_reference': u'CmRdAAAAg0WrbYwSKOUD9Zgzh8yFjn_ht5jdAo8iZA24c5qq7HUGxaYlW-WDoVewd0YXfPznkOYIbfFyOcl573nbJOnabF8qfSNtS8UCq9U4CPv5U1mzeaVRRoqeRBgnNTv8p94fEhD7H0444W9C3TmtN_Fx7eKVGhQIs_uRsNxVfu8BXOa7oBgpqFgDfg',
   u'width': 1366},
  {u'height': 5616,
   u'html_attributions': [u'<a href="https://maps.google.com/maps/contrib/104096622138932892371/photos">Hauz Khas Social</a>'],
   u'photo_reference': u'CmRdAAAAP5cylCwN5-YWBZa5K7EcDxWJetQ2rpJHKiFHbApo6FkdrpkWrBpVHKD26cE8lex45HzpL0LxL-N5GAGsHVkvPSIeXM4fflLsPBrs1vZioDb4-Rwc8l3X_e4Hgb6hRZtnEhAu421kYOJRz9t3w4GX6-w2GhS472CWzg3NTpqwCqcF2_xfGxWT5w',
   u'width': 3744}],
 u'place_id': u'ChIJF0RY2w_iDDkRCz4g9uM_iR8',
 u'rating': Decimal('4.2'),
 u'reference': u'CnRjAAAAiU_X32Yrcjbwgsgmvq_uDQqoQBjgAI7uWzfUc9fWTnI45WgvKsG3MTvYIRlBvHNE8cA-mjO9fElk9aXeATyviv_QM8KK3v03FLbz3w9zCz1cNxqfYn4B4nMxg6F9MNk32X1BxdLngmstvu1YZI2pBxIQPGaTm3n97MI8xzwy2B6QUxoUhvzYFubdTk_qEqGxH3-QLJo5WVg',
 u'reviews': [{u'aspects': [{u'rating': 2, u'type': u'overall'}],
   u'author_name': u'Himanshu Atreja',
   u'author_url': u'https://plus.google.com/114759729758247935047',
   u'language': u'en',
   u'profile_photo_url': u'//lh6.googleusercontent.com/-1P2xqQSkYYw/AAAAAAAAAAI/AAAAAAAAAWE/G_TlfSR84kY/photo.jpg',
   u'rating': 4,
   u'text': u'One of the most happening late night party hotspot in Delhi. Yummy Food with best of drinks ( Not everything on menu is available all times ) . Typical but refreshing serving style makes it apart from others. Mostly its crowded with waiting (even on a tuesday night) . Overall a chilled out place. ',
   u'time': 1451566034},
  {u'aspects': [{u'rating': 3, u'type': u'overall'}],
   u'author_name': u'rohit manchanda',
   u'author_url': u'https://plus.google.com/100673275497411867474',
   u'language': u'en',
   u'profile_photo_url': u'//lh5.googleusercontent.com/-9Cl-NxB_hSQ/AAAAAAAAAAI/AAAAAAAAALM/ZgiwG6j_vh8/photo.jpg',
   u'rating': 5,
   u'text': u'The great Indian pub. \nIt is not just perfect for ambience, food and drinks, but also for its Best balcony in town for smoking. Great couches, peek into The Tomb of Feroz Shah Tuglaq and a beautiful lake surrounded by trees. It is indeed fun exploring various sections of Social. With some Indian ishtyle items in the menu it is fun trying their drinks, food and some dessert if u are up to it. They are reasonably priced which makes sense, as in day time it is a perfect office for freelancers who can plugin their various devices right at the table and use wifi and spend all day working and chillin.\nGreat concept. better vibe \n\nCheers',
   u'time': 1451895929},
  {u'aspects': [{u'rating': 2, u'type': u'overall'}],
   u'author_name': u'TechnOptics _',
   u'author_url': u'https://plus.google.com/100829696974981817294',
   u'language': u'en',
   u'profile_photo_url': u'//lh5.googleusercontent.com/-kt0G4zHdmgs/AAAAAAAAAAI/AAAAAAAAB-A/jetb9cjL7NI/photo.jpg',
   u'rating': 4,
   u'text': u'Provides you with the best view of the hauz khas. The place is spacious and properly sanitized. The food is great too however the pricing is on the higher side. It is still of the finest place in hauz khas village.',
   u'time': 1451486634},
  {u'aspects': [{u'rating': 2, u'type': u'overall'}],
   u'author_name': u'Priyanka Sachar',
   u'author_url': u'https://plus.google.com/104745980455555293335',
   u'language': u'en',
   u'profile_photo_url': u'//lh4.googleusercontent.com/-_fDjNdcMJHw/AAAAAAAAAAI/AAAAAAAAAAA/bgaxAG-8Vrw/photo.jpg',
   u'rating': 4,
   u'text': u'Very large space and great concept of integrating decor with social networks. Great view of the hauz e khas too. My only grouse with all establishments there though is that they are way too close to - sometimes sharing a wall with -  the heritage area which should be preserved at all costs ',
   u'time': 1449144729},
  {u'aspects': [{u'rating': 3, u'type': u'overall'}],
   u'author_name': u'Andrew Rozara',
   u'author_url': u'https://plus.google.com/106864261325460186067',
   u'language': u'en',
   u'profile_photo_url': u'//lh6.googleusercontent.com/-VOoDUdhIWDQ/AAAAAAAAAAI/AAAAAAAAAo0/cfulLwUR8zw/photo.jpg',
   u'rating': 5,
   u'text': u'Great outdoor seating, decent indoor ambience, amazing food, and their Old Smoke is the best whiskey cocktail in the city. ',
   u'time': 1450550022}],
 u'scope': u'GOOGLE',
 u'types': [u'restaurant',
  u'cafe',
  u'night_club',
  u'bar',
  u'food',
  u'point_of_interest',
  u'establishment'],
 u'url': u'https://maps.google.com/?cid=2272417735304560139',
 u'user_ratings_total': 81,
 u'utc_offset': 330,
 u'vicinity': u'9A & 12, Hauz Khas Village, New Delhi',
 u'website': u'http://www.socialoffline.in/'}
"""
import os
import sys
import hashlib
from googleplaces import GooglePlaces, types, lang
import base64
import datetime
#import geocoder
from blessings import Terminal

terminal = Terminal()


fmt = "%d %B %Y %H:%M:%S"



api_key = "AIzaSyBP8cTRShTYIQzMdAXXiQybQ3T3newUTqQ"
google_places = GooglePlaces(api_key)

file_name = os.path.dirname(os.path.abspath(__file__))
parent_dir = os.path.dirname(os.path.dirname(file_name))
sys.path.append(parent_dir)

os.chdir(parent_dir)

from connections import pictures_collection, users_reviews_collection, eateries, eateries_results_collection

os.chdir(file_name)

def find_google_places(eatery_id, __eatery_id, eatery_name, location):

        google = dict()
        latitude, longitude = location
        latitude = float(latitude)
        longitude = float(longitude)
        
        g = GooglePlaces.nearby_search(google_places, name=eatery_name, lat_lng={"lat": latitude, "lng": longitude},  types= [u'restaurant', u'food', u'point_of_interest', u'establishment'])
        
        """
        TODO: If no extry prsent og google places
        if not place:
                return None

        """
        try:
                place = g.places[0]
        except Exception as e:
                print terminal.red(str(e))
                google = "No entry exists on google"
                eateries_results_collection.update({"eatery_id": eatery_id}, {"$set": {"google": google}}, upsert=False)
                print terminal.red("\nNo match can be found for eatery_name %s\n"%(eatery_name))
                return 
        print terminal.green("\nThe match we found for eatery_name %s is %s\n"%(eatery_name, place))


        place.get_details()
        result = place.details
        address_components = result.get("address_components")
        eatery_address = result.get("formatted_address")
        eatery_phone_number = result.get("formatted_phone_number")
        location = [float(result.get("geometry").get("location").get("lat")), float(result.get("geometry").get("location").get("lng"))]
        place_id = result.get("place_id")
        eatery_international_phone_number = result.get("international_phone_number")
        opening_hours = result.get("opening_hours")
        
        """
        pic_list = list()


        if place.photos:
                print terminal.green("\n Pics found for  eatery_name %s are %s\n"%(eatery_name, len(place.photos)))
                for picture in place.photos:
                        picture.get(picture.orig_width, picture.orig_height)
                        print picture.filename
                        pic_list.append({"data": picture.data, "width": picture.orig_width, "height": picture.orig_height, "url": picture.url})
        else:
                print terminal.red("No pic can be found for %s <<[%s, %s]>>"%(eatery_name, latitude, longitude))

        """
        review_list = list()

        if result.get("reviews"):
                for review in result.get("reviews"):
                        review_list.append(review)

        else:
                print terminal.red("No reviews can be found for %s <<[%s, %s]>>"%(eatery_name, latitude, longitude))
                
                
        google.update({"location": location, "eatery_address": eatery_address, "eatery_phone_number": eatery_phone_number, \
                "place_id": place_id, "address_components": address_components, "eatery_international_phone_number": eatery_international_phone_number,\
                "opening_hours": opening_hours})

        #insert_images(__eatery_id, eatery_name, pic_list)
        insert_reviews(eatery_id, __eatery_id, eatery_name, review_list)
        eateries_results_collection.update({"eatery_id": eatery_id}, {"$set": {"google": google}}, upsert=False)
        return google


def google_already_present(eatery_id, google):
            if google == "No entry exists on google":
                    eateries_results_collection.update({"eatery_id": eatery_id}, {"$set": {"google": "No entry exists on google"}}, upsert=False)
                    return 

            if google.get("address_components"):
                    ##this implies that the google had lready been updated 
                    eateries_results_collection.update({"eatery_id": eatery_id}, {"$set": {"google": google}}, upsert=False)
                    return 
            
            
            eatery_result = eateries.find_one({"eatery_id": eatery_id})
            __eatery_id = eatery_result.get("__eatery_id")
            eatery_name = eatery_result.get("eatery_name")
            print google

            try:
                    review_list = google.pop("reviews")
            except Exception as e:
                    print e
                    print "No reviews present for %s"%eatery_id
                    review_list = []

            try:
                    pic_list = google.pop("pictures")
            except Exception as e:
                    print e
                    print "No pictures present for %s"%eatery_id
                    pic_list = []


            latitude, longitude = google.get("location")
            latitude, longitude = float(latitude), float(longitude)
            google.update({"location": [latitude, longitude]})
            try:
                    address_components = google.pop("pincode")
            except Exception as e:
                    try:
                            address_components = google.pop("address_components")
                    except Exception as e:
                            g = GooglePlaces.nearby_search(google_places, name=eatery_name, lat_lng={"lat": latitude, "lng": longitude},  types= [u'restaurant', u'food', u'point_of_interest', u'establishment'])
                                                        
                            place = g.places[0]
                            place.get_details()
                            result = place.details
                            address_components = result.get("address_components")



            google.update({"address_components":address_components})

            print review_list
            print len(pic_list)
            insert_images(__eatery_id, eatery_name, pic_list)
            insert_reviews(__eatery_id, eatery_name, review_list)
            eateries_results_collection.update({"eatery_id": eatery_id}, {"$set": {"google": google}}, upsert=False)
            eateries.update({"eatery_id": eatery_id}, {"$set": {"google": google}}, upsert=False)
            return 






def insert_images(__eatery_id, eatery_name, pic_list):
        for pic in pic_list:
                data = pic.pop("data")
                data = base64.b64encode(data)
                pic_id = hashlib.sha256(data + __eatery_id).hexdigest() 
                pic.update({"pic_id": pic_id, "__eatery_id": __eatery_id, "eatery_name": eatery_name, "data": data})
                try:
                        print pictures_collection.insert(pic)
                except Exception as e:
                        print terminal.red(str(e))
                        print terminal.red("Error occureed in pic_id %s"%pic_id)


        return 





def insert_reviews(eatery_id, __eatery_id, eatery_name, review_list):
        fmt = "%d %B %Y %H:%M:%S"
        if not review_list:
                return 


        for review in review_list:
            if review.get("text"):
                epoch = datetime.datetime.fromtimestamp(review.get("time")).strftime(fmt)
                review_text = review.pop("text")
                fb_id = "google"
                review_id = hashlib.md5(epoch + __eatery_id + review_text.encode("ascii", "ignore") + fb_id).hexdigest() 
                name = review.pop("author_name")
                review.update({"fb_id": fb_id, "eatery_name": eatery_name, "name": name, "epoch": epoch, "review_text": review_text, "review_id": review_id, "eatery_id": eatery_id, "__eatery_id": __eatery_id})
                print review
                try:
                        print terminal.green(str(users_reviews_collection.insert(review)))
                except Exception as e:
                        print terminal.red(str(e))
                        print terminal.red("Error occurred in review_id = %s"%review_id)
        return 











